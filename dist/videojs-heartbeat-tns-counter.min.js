/**
 * videojs-heartbeat-tns-counter
 * @version 1.0.3
 * @copyright 2018 Sergey Gromkov <sgromkov@gmail.com>
 * @license MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("video.js")):"function"==typeof define&&define.amd?define(["video.js"],e):t.videojsHeartbeatTnsCounter=e(t.videojs)}(this,function(t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n=(function(){function t(t){this.value=t}function e(e){function n(o,i){try{var s=e[o](i),a=s.value;a instanceof t?Promise.resolve(a.value).then(function(t){n("next",t)},function(t){n("throw",t)}):r(s.done?"return":"normal",s.value)}catch(t){r("throw",t)}}function r(t,e){switch(t){case"return":o.resolve({value:e,done:!0});break;case"throw":o.reject(e);break;default:o.resolve({value:e,done:!1})}(o=o.next)?n(o.key,o.arg):i=null}var o,i;this._invoke=function(t,e){return new Promise(function(r,s){var a={key:t,arg:e,resolve:r,reject:s,next:null};i?i=i.next=a:(o=i=a,n(t,e))})},"function"!=typeof e.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype.throw=function(t){return this._invoke("throw",t)},e.prototype.return=function(t){return this._invoke("return",t)}}(),function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}),r={catid:null,vcid:null,vcver:0,fts:null,vts:null,evtp:null,dvtp:navigator.userAgent.match(/Android( |%20)|iPhone|iPad|iPod|Tizen|Phone/i)?navigator.userAgent.match(/iPhone|iPod|iPad/i)?2:navigator.userAgent.match(/Android/i)?3:navigator.userAgent.match(/Windows/i)?4:navigator.userAgent.match(/Tizen/i)?7:void 0:1,adid:null,advid:null,idfa:null,dvid:null,mac:null,app:null,TnsAccount:null,tmsec:null,interval:3e4,live:!1,dvr:!1,serverTimestamp:0},o=t.registerPlugin||t.plugin,i=function(){function r(t,e){n(this,r),this.player=t,this.options=e,this.tnsTimer=null,this.clientServerTimeDifference=0,this.allPrerollsEnded=!1,this.prerollExists=!1,this.pauseFts=null;var o=Math.floor(Date.now()/1e3);this.options.serverTimestamp&&(this.clientServerTimeDifference=o-this.options.serverTimestamp)}return r.prototype.getValidFts=function(t,e,n){var r=Math.round(t);return this.options.live&&(r=r<0?e+r-n:e-n),r},r.prototype.requestTnsTimerStarting=function(){if("object"===e(this.player.ima)&&!this.allPrerollsEnded)return t.log("heartbeatTnsCounter start is break"),!1;this.tnsTimerStarted||(this.tnsTimerStarted=!0,this.startTNSTimer())},r.prototype.startTNSTimer=function(){var t=this,e=function(){var e=t.player.currentTime(),n=t.clientServerTimeDifference,r=Math.floor(Date.now()/1e3),o=t.player.paused()?t.pauseFts:t.getValidFts(e,r,n),i={catid:t.options.catid,vcid:t.options.vcid,vcver:t.options.vcver,fts:o,vts:r,evtp:t.options.live?1:2,dvtp:t.options.dvtp,adid:t.options.adid,advid:t.options.advid,idfa:t.options.idfa,dvid:t.options.dvid,mac:t.options.mac,app:t.options.app},s=("https:"===document.location.protocol?"https://":"http://")+"www.tns-counter.ru/V13a**";for(var a in i)i.hasOwnProperty(a)&&null!==i[a]&&""!==i[a]&&(s+=a+":"+i[a]+":");s=s.substr(0,s.length-1),s+="**"+t.options.TnsAccount+"/ru/UTF-8/tmsec="+t.options.tmsec+"/",(new Image).src=s};this.tnsTimer=setInterval(e,this.options.interval),e()},r.prototype.stopTNSTimer=function(){clearInterval(this.tnsTimer)},r.prototype.ready=function(){var e=this;t.log("heartbeatTnsCounter Plugin ENABLED!",this.options),this.player.addClass("vjs-videojs-heartbeat-tns-counter"),this.player.one("prerollExists",function(){e.prerollExists=!0}),this.player.one("allPrerollsEnded",function(){e.allPrerollsEnded=!0,e.prerollExists&&!e.options.live&&(e.player.pause(),e.player.currentTime(0),e.player.play()),e.requestTnsTimerStarting()}),this.player.on("play",function(){e.requestTnsTimerStarting()}),this.player.on("pause",function(){var t=e.player.currentTime(),n=e.clientServerTimeDifference,r=Math.floor(Date.now()/1e3);e.pauseFts=e.getValidFts(t,r,n)}),this.player.on("ended",function(){e.tnsTimerStarted=!1,e.stopTNSTimer()})},r}(),s=function(e){new i(this,t.mergeOptions(r,e)).ready()};return o("heartbeatTnsCounter",s),s.VERSION="1.0.3",s});